trigger:
  branches:
    include:
      - features/*

pr:
  branches:
    include:
      - features/*
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  SNYK_AUTH: '45678901'
  SNYK_AUTH_TOKEN: $(SNYK_AUTH) # Securely store this in Azure DevOps pipeline variables

jobs:
- job: BuildAndScan
  displayName: 'Build and Security Scan'
  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '22.x' # Specify the Node.js version
      checkLatest: true
  

  - script: npm install
    displayName: 'Install Dependencies'

  - script: npm i sharp
    displayName: 'install image optimizer'

  - script: |
         npm install set fund false
         set cache .npm
  
  - script: npm run build
    displayName: 'Build the Project'
  - script: |
         npm install set fund false
         set cache .npm
  
- job: SnykScan
  displayName: 'Snyk Security Scan'
  dependsOn: BuildAndScan
  steps:
  - script: |
        echo "Running Snyk security scan"
        npm install -g snyk 
        npm config set fund false
        SNYK_TOKEN=<SNYK_API_TOKEN> snyk test
        snyk test --severity-threshold=high --json > snyk-results.json
    displayName: 'Run Snyk Scan'

         


  